<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Check History - URL Health Checker</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <nav class="bg-white shadow mb-6 px-4 py-3 flex justify-between items-center">
    <h1 class="text-lg font-semibold text-blue-600">URL Health Checker</h1>
    <div class="space-x-4 text-sm">
      <a href="/" class="text-gray-600 hover:text-blue-600">Dashboard</a>
      <a href="/history.html" class="text-blue-600 font-medium">History</a>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto px-4 pb-12">
    <section class="bg-white p-4 rounded shadow mb-6">
      <div class="flex flex-wrap gap-3">
        <input id="filterUrl" placeholder="Filter by URL..." class="border rounded px-3 py-2 flex-1" />
        <select id="filterStatus" class="border rounded px-3 py-2 w-40">
          <option value="">All</option>
          <option value="success">Success</option>
          <option value="error">Error</option>
        </select>
        <input id="filterDateFrom" type="date" class="border rounded px-3 py-2 w-40" />
        <input id="filterDateTo" type="date" class="border rounded px-3 py-2 w-40" />
        <button onclick="applyFilters()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm">Apply</button>
        <button onclick="clearFilters()" class="border px-4 py-2 rounded text-sm">Clear</button>
      </div>
    </section>
    <section class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
      <div class="bg-white p-4 rounded shadow text-center">
        <div class="text-xs text-gray-500">Total</div>
        <div id="statTotal" class="text-xl font-semibold text-blue-600">0</div>
      </div>
      <div class="bg-white p-4 rounded shadow text-center">
        <div class="text-xs text-gray-500">Success</div>
        <div id="statSuccess" class="text-xl font-semibold text-green-600">0</div>
      </div>
      <div class="bg-white p-4 rounded shadow text-center">
        <div class="text-xs text-gray-500">Failed</div>
        <div id="statFailed" class="text-xl font-semibold text-red-600">0</div>
      </div>
      <div class="bg-white p-4 rounded shadow text-center">
        <div class="text-xs text-gray-500">Avg Time</div>
        <div id="statAvgResponse" class="text-xl font-semibold">0ms</div>
      </div>
    </section>
    <section class="bg-white p-4 rounded shadow">
      <div class="flex justify-between items-center mb-3">
        <h2 class="font-medium text-sm">History</h2>
        <div class="flex gap-3 text-sm">
          <button onclick="exportToCSV()" class="flex items-center gap-1 hover:text-gray-700">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor"
                 stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg> Export
          </button>
          <button onclick="loadHistory()" class="flex items-center gap-1 hover:text-gray-700">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor"
                 stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="23 4 23 10 17 10"/>
              <polyline points="1 20 1 14 7 14"/>
              <path d="M3.5 9a9 9 0 0 1 14.1-3.4L23 10"/>
              <path d="M20.5 15a9 9 0 0 1-14.1 3.4L1 14"/>
            </svg> Refresh
          </button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-sm border-t">
          <thead class="bg-gray-50 text-left">
            <tr>
              <th class="p-2">URL</th>
              <th class="p-2">Status</th>
              <th class="p-2">Response</th>
              <th class="p-2">Timestamp</th>
              <th class="p-2">Error</th>
            </tr>
          </thead>
          <tbody id="historyTableBody">
            <tr><td colspan="5" class="text-center py-8 text-gray-500">Loading...</td></tr>
          </tbody>
        </table>
      </div>

      <div class="flex justify-between items-center mt-4 text-xs text-gray-600">
        <span>Showing <span id="showingCount">0</span> records</span>
        <div class="flex gap-2">
          <button id="prevBtn" onclick="previousPage()" class="border px-3 py-1 rounded" disabled>Prev</button>
          <button id="nextBtn" onclick="nextPage()" class="border px-3 py-1 rounded" disabled>Next</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    let allHistory = [], filteredHistory = [], currentPage = 1;
    const perPage = 50;

    async function loadHistory() {
      try {
        const res = await fetch('/history/all');
        const data = await res.json();
        allHistory = data.history || [];
        filteredHistory = [...allHistory];
        currentPage = 1;
        updateStats();
        renderTable();
      } catch {
        document.getElementById('historyTableBody').innerHTML =
          `<tr><td colspan="5" class="text-center py-8 text-red-500">Failed to load</td></tr>`;
      }
    }

    function applyFilters() {
      const url = filterUrl.value.toLowerCase();
      const status = filterStatus.value;
      const from = filterDateFrom.value;
      const to = filterDateTo.value;

      filteredHistory = allHistory.filter(h => {
        if (url && !h.url.toLowerCase().includes(url)) return false;
        if (status === 'success' && (h.status < 200 || h.status >= 400)) return false;
        if (status === 'error' && (h.status >= 200 && h.status < 400)) return false;
        const date = new Date(h.timestamp).toISOString().split('T')[0];
        if (from && date < from) return false;
        if (to && date > to) return false;
        return true;
      });

      currentPage = 1;
      updateStats();
      renderTable();
    }

    function clearFilters() {
      filterUrl.value = filterStatus.value = filterDateFrom.value = filterDateTo.value = '';
      filteredHistory = [...allHistory];
      currentPage = 1;
      updateStats();
      renderTable();
    }

    function updateStats() {
      const total = filteredHistory.length;
      const success = filteredHistory.filter(h => h.status >= 200 && h.status < 400).length;
      const fail = total - success;
      const avg = total ? Math.round(filteredHistory.reduce((s,h)=>s+(h.duration||0),0)/total) : 0;
      statTotal.textContent = total;
      statSuccess.textContent = success;
      statFailed.textContent = fail;
      statAvgResponse.textContent = avg + 'ms';
    }

    function renderTable() {
      const start = (currentPage-1)*perPage;
      const rows = filteredHistory.slice(start, start+perPage).map(h=>{
        const ok = h.status>=200 && h.status<400;
        const badge = `<span class="px-2 py-0.5 text-xs rounded bg-${ok?'green':'red'}-100 text-${ok?'green':'red'}-700">${h.status||'Fail'}</span>`;
        return `<tr class="border-t">
          <td class="p-2 truncate" title="${h.url}">${h.url}</td>
          <td class="p-2">${badge}</td>
          <td class="p-2">${h.duration||'-'}ms</td>
          <td class="p-2">${new Date(h.timestamp).toLocaleString()}</td>
          <td class="p-2 text-red-600">${h.error?h.error.slice(0,50):'-'}</td>
        </tr>`;
      }).join('');

      historyTableBody.innerHTML = rows || `<tr><td colspan="5" class="text-center py-8 text-gray-500">No data</td></tr>`;
      showingCount.textContent = `${Math.min(filteredHistory.length, start+1)}-${Math.min(filteredHistory.length, start+perPage)} of ${filteredHistory.length}`;
      prevBtn.disabled = currentPage===1;
      nextBtn.disabled = start+perPage>=filteredHistory.length;
    }

    function previousPage(){ if(currentPage>1){ currentPage--; renderTable(); } }
    function nextPage(){ if(currentPage*perPage<filteredHistory.length){ currentPage++; renderTable(); } }

    function exportToCSV(){
      const csv = ['URL,Status,Response,Timestamp,Error'];
      filteredHistory.forEach(h=>{
        csv.push(`"${h.url}","${h.status||'Fail'}","${h.duration||''}","${h.timestamp}","${(h.error||'').replace(/"/g,'""')}"`);
      });
      const blob = new Blob([csv.join('\n')],{type:'text/csv'});
      const link = Object.assign(document.createElement('a'),{href:URL.createObjectURL(blob),download:'history.csv'});
      link.click();
    }

    window.addEventListener('load', loadHistory);
  </script>
</body>
</html>
